<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Africa CDC Public Dashboards</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body>
    <div id="app">
        <!-- <div v-if="loading">
            <h1>Logging in...</h1>
        </div> -->

        <div v-if="errorMessage">
            <p style="color: red;">{{ errorMessage }}</p>
        </div>

        <div v-if="dashboardLoaded">
            <h1>DHIS2 Dashboard</h1>
            <iframe :src="dashboardUrl" width="100%" height="600px" frameborder="0" allowfullscreen></iframe>
        </div>
    </div>

    <script>
        new Vue({
            el: '#app',
            data: {
                loading: true,
                errorMessage: '',
                dashboardUrl: '',
                dashboardLoaded: false
            },
            mounted() {
                this.autoLogin();
            },
            methods: {
                async autoLogin() {
                    try {
                       const baseUrl = window.location.origin;
                        console.log("Base URL is: " + baseUrl);

                        let baseUrlF; // Declare variable

                        // Check if the base URL contains 'localhost' or '127.0.0.1'
                        if (baseUrl.includes('localhost') || baseUrl.includes('127.0.0.1')) {
                            baseUrlF = baseUrl + ':3000'; // Concatenate port 3000 for localhost
                        } else {
                            baseUrlF = baseUrl; // Keep the remote server URL unchanged
                        }

                        console.log("Final Base URL is: " + baseUrlF);
                        const response = await axios.post(baseUrlF+'/node_app/login/', {}, {
                            withCredentials: true // Essential for including cookies in the request
                        });

                        if (response.status === 200 && response.data.message === 'Login successful') {
                            this.dashboardUrl = response.data.dashboardUrl;
                            this.dashboardLoaded = true;
                            this.loading = false;
                        } else {
                            this.loading = false;
                            this.errorMessage = 'Failed to load dashboard: ' + (response.data.message || 'No message');
                        }
                    } catch (error) {
                        this.loading = false;
                        this.errorMessage = 'Login failed: ' + (error.response?.data?.message || 'Unknown error');
                    }
                }
            }
        });
    </script>
</body>

</html>